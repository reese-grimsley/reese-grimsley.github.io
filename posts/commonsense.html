<!DOCTYPE HTML>
<!--
	Read Only by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>RG - Common Sense</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="../assets/css/main.css" />
	</head>
	<body class="is-preload">

		<!-- Header -->
			<section id="header">
				<p><a href="../index.html">Back to home</a></p>	
				<header>
					<span class="image sidebar"><img src="../images/main+debug.jpg " style="width:50%;height:50%"/></span>
					<p >
						<strong>CommonSense Low-Power IoT Sensing Prototype Architecture<br></strong>
					</p>
				</header>
				<nav id="nav">
					<ul>
						<li><a href="#concept">A Sensical Concept</a></li>
						<li><a href="#design">Design Experiences</a></li>
						<li><a href="#build">Building and Testing</a></li>
						<li><a href="#firmware">Firmware Framework</a></li>
						<li><a href="#trafficnnode">TinyML on CommonSense</a></li>
						<li><a href="#finalstate">The (Sad) Future of Reseach Prototypes</a></li>
					</ul>
				</nav>
				<footer>
					<ul class="icons">
						<li><a href="https://github.com/reese-grimsley" class="fab fa-github"><span class="label"></span></a></li>
						<li><a href="mailto:reeseg@cmu.edu" class="icon solid fa-envelope"><span class="label">Email</span></a></li>
					</ul>
				</footer>
			</section>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">

						<!-- One -->
							<section id="concept">
								<div class="image main" data-position="center">
									<img src="../images/CS_stack_rev1_front.jpg" />
								</div>
								<div class="container">
									<p style="font-size:120%">
										<b>This post is not done. Go away. </b>
									</p>

									<p style="font-size:100%"">
										<br><br><br>
										CommonSense is a embedded hardware project that I ran within the Connected Embedded Systems Lab under Bob Iannucci at the CMU Silicon Valley Campus. In previous experiments with traffic and environmental sensing, Bob's group found that many of their hardware designs were at least 70% identical, leading to avoidable engineering effort as they redid much of the same work for each new design.
										<br><br>
										Conceptually, CommonSense was meant to reduce this engineering effort by having one PCB that hosted the application invariants, like the processor, power regulators, basic sensors (e.g., temperature & humidity), and another PCB (potentially multiple) that hosted the application specific hardware, like WiFi radios, SDI-12 transducer interfaces, audio output, etc. The goal was to separate design efforts and reuse as much as possible, including abstractions to help manage communication interfaces and power management.
										<br><br>
										If this sounds like most other hobbyist-friendly designs like Arduino, BeagleBone, or Raspberry Pi, that's because it is. However, we aimed to target ultra low-power applications (where a single battery must last months or years) and teach students how to develop these applications. The aforementioned designs are not well optimized for power, which was a major goal for our projects. Libelium has good ultra low-power turnkey solutions for sensors (WaspMotes), but we wanted more than an 8-bit microcontroller, especially since our favorite application was street-mounted sensors running neural nets for vehicle detection and classification.
										<br><br>
										We came up with a design that included 3+ vertically stacked boards. The 'brain' would be the main CommonSense board, with a solid low-power processor and interfaces galore. The app-specific 'daughter' boards would go on top, containing radios, sensors, and actuators, but should be stackable in any order without interrupting each other; our design allowed for several of these to be used. Finally, the 3rd 'debug' PCB would include power diagnostics and more convenient IO ports.
									</p>
								</div>
							</section>
	
							<section id="design">
								<div class="container">
									<h3>Design Experiences</h3>
									<p style="font-size:80%;">
										I could speak at great length about the CommonSense design and the process &mdash; this was my first real hardware design. I'll aim for brevity in describing my experiences and lessons when doing the initial designs.
										<br><br>
										On its own, the main CommonSense board was very simple: voltage input, a regulator, a processor (a Atmel D51 Cortex M4F), a couple of sensors, and external FLASH. Simple. 
										<br><br>
										Yet, the need to interface with multiple app-specific boards meant the interfaces needed much forethought. The D51 processor has a series of 8 reconfigurable serial buses that could switch between SPI, I2C, and USART easily, but not all pins are created equal - this required a great deal of attention (read, finagling) to expose 4 entirely flexible buses to the stacked app-specific cards, 2 for more generic internal use, and 2 to the debugging board.
										<br><br>
										Another interesting component in this design was to include current sensing such that the attached debug board, based on the <a href="http://ccsg.ece.cmu.edu/wiki/doku.php?id=public:powerdue:home">PowerDue</a> could apply its high-side current monitoring to each of the 4 voltage rails (processor, storage, and 2 for daughter boards). In reality, this mainly involved including shunt resistors on the main board and connecting a trace from each side to board-to-board interace such they both inputs could be connected to the differential amplifier within the current monitor.
										<br><br> 
										The mechanical mounting was also important to get right in this scenario, since we needed low-pitch (.4mm) mezzanine connectors to pass signals between the main board and the debug/daughter board. We needed low-profile connectors to save space, but these provide poor mechanical strength, so I opted to also allocate space for fasteners. This worked well in practice, but finding small screws/standoffs of the right length is surprisingly difficult.
										<br><br> 
										Altogether, I enjoyed the design phase, in particular, doing PCB layouts since it is much like solving a puzzle
									</p>
								</div>
							</section>


							<section id="build">
								<div class="container">
								<h3>Building and Testing</h3>
								<p style="font-size:80%;">
									The obvious next stage of the project was having boards produced, assembled, and tested. In total, I did 3 revisions of the main board, 2 of the debug board, and another PhD student in our group did 2 revisions of a daughter board. 
									<br><br>
									In the first version of CommonSense, I hand-populated 2 boards and did the basic testing to ensure it worked. It did, but designing a board with 50 0402-sized passive components may not have been the wisest decision for someone with limited SMD experience. To be fair, this gave me plenty of experience for future rework on this project and others. After that version of the board, we switched the processor to a BGA form factor, at which point hand-assembly was far from ideal. In each version of the board, the basic mode of operation was a complete success &mdash; the processor booted and responded perfectly to the JTAG interface. 
									<br><br>
									Not everything was perfect, of course. I learned quickly that easily-accessible test points are massively useful for checking voltages at key points in the board, like regulator input/outputs and serial buses. I would later find that to achieve low-power operation, a MOSFET-based power switch used to preferentially power the board via the debug-board connector should not be present &mdash; too much static loss for low micro-amp sleep-state! By revision 3, the sleep state current for this main board was down to 35 &mu; with RAM retention
									<br><br>
									I also hand-populated the first revision of the debug boards, which easily contained over 100 parts. Producing 3 of these without a pick-and-place machine or an oven was very time consuming, but I certainly improved my skills with an iron and a heat gun. This was 3 months into the COVID-19 pandemic, and my living room was converted into a SMD workstation. Some of my prouder moments include building series/parallel resistor chains from 0402s to cover up for my limited supply of parts. 
									<br><br>
									In general, the debug boards worked too, but a few simple errors with missing pull-up/pull-down resistors and swapped D+/D- USB pins lengthed the functional tests. However, a fun lesson was in the current monitoring: the debug board included 4 high side current monitors to look at power consumption of the main board. The output was read by another microcontroller and sent to a serial port via USB to an interface reminiscent of an o-scope. However, instead of a clean signal showing the expected 20mA in active state, it was a nasty mess; noise everywhere. The problem? A switch-mode (buck-boost) voltage regulator on the main board whose 200mV pk-pk swings ran at frequencies lower that the cutoff (dependent on output current). When I swapped to an LDO, the problems vanished. Lesson: switch mode regulators are efficient, but the transients are not negligible for anything analog.
									<br><br>
									Since I did not design nor extensively test the daughter boards, I won't speak to that side of this project, but building and testing the hardware I <i>did</i> design was a huge learning experience.
								</p>
								</div>
							</section>

							<section id="firmware">
								<div class="container">
									<h3>Firmware Framework</h3>
									<p style="font-size:80%;">
										.
									</p>
								</div>
							</section>

							<section id="trafficnode">
								<div class="container">
									<h3>TinyML on CommonSense: The TrafficNNode</h3>
									<p style="font-size:80%;">
										.
									</p>
								</div>
							</section>

							<section id="finalstate">
								<div class="container">
									<h3>The (Sad) Future of Reseach Prototypes</h3>
									<p style="font-size:80%;">
										.
									</p>
								</div>
							</section>

					</div>

				<!-- Footer -->
					<!-- <section id="footer">
						<div class="container">
							<ul class="copyright">
								<li>&copy; Reese Grimsley. All rights reserved.</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
							</ul>
						</div>
					</section> -->

			</div>

		<!-- Scripts -->
			<script src="../assets/js/jquery.min.js"></script>
			<script src="../assets/js/jquery.scrollex.min.js"></script>
			<script src="../assets/js/jquery.scrolly.min.js"></script>
			<script src="../assets/js/browser.min.js"></script>
			<script src="../assets/js/breakpoints.min.js"></script>
			<script src="../assets/js/util.js"></script>
			<script src="../assets/js/main.js"></script>

	</body>
</html>
